<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root { --primary: #1a73e8; --bg: #f8f9fa; --border: #dadce0; }
    body { padding:0; margin:0; font-family:'Roboto',Arial,sans-serif; font-size:14px; background:var(--bg); }
    .header { background:white; padding:16px; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10; }
    select { width:100%; padding:8px; border-radius:4px; border:1px solid var(--border); margin-top:6px; }
    
    /* CORREÇÃO APLICADA (Item 1.1):
       Adicionado 'padding-bottom: 100px' para garantir que o último item da lista 
       não fique escondido atrás do rodapé fixo (.footer) ao rolar até o fim. 
    */
    .content-scroll { 
      height:calc(100vh - 200px); 
      overflow-y:auto; 
      padding:16px; 
      padding-bottom: 100px; 
    }
    
    .content-scroll::-webkit-scrollbar { width: 6px; }
    .content-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    .group-container { background:white; border:1px solid var(--border); border-radius:8px; margin-bottom:12px; overflow:hidden; }
    .cat-row { padding:10px; border-bottom:1px solid #eee; }
    .sub-list { background:#f8f9fa; padding:5px 0 5px 15px; border-top:1px solid #f1f3f4; }
    .sub-row { padding:8px 10px; border-left:2px solid #ddd; margin:4px 0 4px 5px; background:white; }
    .item-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
    .item-title { display:flex; align-items:center; flex:1; min-width:0; }
    .item-label { font-weight:500; font-size:12px; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .preview-box { font-size:9px; padding:4px 8px; border-radius:3px; border:1px solid #ccc; min-width:35px; text-align:center; font-weight:600; }
    .controls { display:flex; gap:4px; align-items:center; margin-top:4px; }
    .color-input-group { display:flex; flex-direction:column; gap:2px; }
    .color-label { font-size:9px; color:#5f6368; text-transform:uppercase; font-weight:600; letter-spacing:0.3px; }
    input[type="color"] { width:40px; height:24px; border:1px solid #ccc; border-radius:3px; padding:0; cursor:pointer; }
    .btn-bold { cursor:pointer; color:#dadce0; padding:4px 6px; border-radius:3px; border:1px solid transparent; font-size:14px; font-weight:bold; min-width:28px; text-align:center; }
    .btn-bold.active { color:var(--primary); background:#e8f0fe; font-weight:bold; }
    .btn-reset, .btn-copy { background:#f8f9fa; border:1px solid #dadce0; border-radius:3px; padding:3px 5px; cursor:pointer; color:#5f6368; min-width:28px; display:flex; align-items:center; justify-content:center; }
    .btn-reset:hover, .btn-copy:hover { background:#e8eaed; color:#202124; }
    
    .btn-guia {
      display: flex; align-items: center; justify-content: center; width: 100%;
      margin-top: 12px; padding: 10px; background: #e8f0fe; 
      border: 1px solid #d2e3fc; border-radius: 6px;
      color: #1967d2; font-weight: 500; font-size: 13px; cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .btn-guia:hover { background: #d2e3fc; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    .btn-reset-subs { background:#fce8e6; border:1px solid #f6c7c2; border-radius:3px; padding:3px 5px; cursor:pointer; color:#c5221f; min-width:28px; display:flex; align-items:center; justify-content:center; margin-left: 2px; }
    .btn-reset-subs:hover { background:#fad2cf; color:#a50e0e; }

    .btn-copy.copied { background:#e8f0fe; color:#1a73e8; }
    .footer { background:white; padding:12px 16px; border-top:1px solid var(--border); position:fixed; bottom:0; width:100%; text-align:center; box-sizing:border-box; }
    .btn-save { background:var(--primary); color:white; border:none; padding:10px 24px; border-radius:24px; cursor:pointer; width:100%; font-weight:500; }
    .btn-save:disabled { background:#dadce0; cursor:not-allowed; }
    #loading { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.95); z-index:1000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .status-msg { margin-top:8px; font-size:12px; min-height:18px; }
  </style>
</head>
<body>
  <div id="loading">
    <div id="spin"><span class="material-icons" style="font-size:32px;color:#1a73e8;animation:spin 1s infinite linear;">refresh</span><p>Carregando...</p></div>
    <div id="err" style="display:none;text-align:center;"><p id="err-txt" style="color:red;"></p><button onclick="location.reload()">Tentar Novamente</button></div>
  </div>
  <div id="app" style="display:none;">
    <div class="header">
      <label style="color:#5f6368;font-weight:500;font-size:12px;">Selecione a Lista:</label>
      <select id="listaSelector"></select>
      
      <button class="btn-guia" onclick="abrirGuiaVisual()">
        <span class="material-icons" style="font-size:18px; margin-right:8px;">menu_book</span>
        Abrir Guia Visual de Cores
      </button>
      
      <div style="margin-top:12px;padding:8px;background:#f1f3f4;border-radius:6px;display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:11px;color:#5f6368;font-weight:500;">Fonte Ativa:</span>
        <label style="display:flex;align-items:center;cursor:pointer;gap:6px;">
          <input type="checkbox" id="toggleFonte" style="width:auto;height:auto;" checked>
          <span id="labelFonte" style="font-size:12px;font-weight:bold;color:#1a73e8;">Sidebar (Personalizado)</span>
        </label>
      </div>
      
      <details style="margin-top:12px;padding:8px;background:#f8f9fa;border:1px solid #dadce0;border-radius:8px;">
        <summary style="cursor:pointer;font-weight:600;color:#202124;">Configuração em lote (JSON)</summary>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="btnExportJson" class="btn-copy" type="button">Exportar JSON</button>
          <button id="btnImportJson" class="btn-reset" type="button">Importar JSON</button>
        </div>
        <textarea id="bulkJson" style="margin-top:10px;width:100%;height:160px;font-family:Consolas,monospace;font-size:11px;white-space:pre;" placeholder="Clique em Exportar JSON, edite em massa, e depois clique em Importar JSON."></textarea>
        <div style="margin-top:6px;font-size:11px;color:#5f6368;">Nota: Importar substitui TODA a configuração salva (overwrite).</div>
      </details>    
    </div>
    
    <div class="content-scroll" id="dynamicContentArea">
      <p style="text-align:center;color:#888;margin-top:40px;">Selecione uma opção acima para começar a editar.</p>
    </div>
    
    <div class="footer">
      <button id="saveBtn" class="btn-save" onclick="salvar()" disabled><span class="material-icons" style="vertical-align:middle;font-size:18px;">save</span> SALVAR ALTERAÇÕES</button>
      <div id="statusMsg" class="status-msg"></div>
    </div>
  </div>
  <style>@keyframes spin{100%{transform:rotate(360deg);}}</style>
  <script>
    let GLOBAL_DATA = {};
    let CURRENT_LIST_ID = null;
    let FONTE_ATIVA = 'SIDEBAR';
    let CLIPBOARD_FORMAT = null;
    
    function normalizeKey(str) {
      return (str || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim().toUpperCase();
    }
    
    function abrirGuiaVisual() {
      google.script.run.abrirGuiaVisual();
    }
    
    function setStatus(msg, color) {
      const el = document.getElementById('statusMsg');
      el.textContent = msg;
      el.style.color = color || '#333';
    }
    
    function showError(msg) {
      document.getElementById('spin').style.display = 'none';
      document.getElementById('err').style.display = 'block';
      document.getElementById('err-txt').textContent = msg;
    }
    
    function carregarDados() {
      google.script.run
        .withSuccessHandler(init)
        .withFailureHandler(function(e) {
          showError(e.message || e);
        })
        .getDadosConfiguracao();
    }
    
    function init(res) {
      if (!res.sucesso) return showError(res.erro);
      GLOBAL_DATA = res.dados;
      const sel = document.getElementById('listaSelector');
      sel.innerHTML = '<option value="">-- Selecione --</option>';
      Object.keys(GLOBAL_DATA).sort().forEach(function(id) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.text = GLOBAL_DATA[id].nomeExibicao;
        sel.appendChild(opt);
      });
      sel.onchange = function(e) {
        render(e.target.value);
      };
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    }
    
    function render(id) {
      CURRENT_LIST_ID = id;
      const area = document.getElementById('dynamicContentArea');
      const btn = document.getElementById('saveBtn');
      area.innerHTML = '';
      setStatus('');
      
      if (!id) { 
        btn.disabled = true; 
        return; 
      }
      btn.disabled = false;
      const data = GLOBAL_DATA[id];
      const cfg = data.configuracaoAtual || { cores: {}, coresSubcategoria: {} };
      const hier = data.hierarquia || {};
      if (Object.keys(hier).length === 0) { 
        area.innerHTML += '<p style="text-align:center;color:#999">Lista vazia na aba DADOS.</p>'; 
        return; 
      }
      Object.keys(hier).forEach(function(cat) {
        const div = document.createElement('div');
        div.className = 'group-container';
        const cRow = document.createElement('div');
        cRow.className = 'cat-row';
        cRow.appendChild(createCtrl(cat, cfg.cores[cat], 'cores', 'Categoria'));
        div.appendChild(cRow);
        const subs = hier[cat];
        if (subs && subs.length) {
          const sList = document.createElement('div');
          sList.className = 'sub-list';
          subs.forEach(function(s) {
            const sRow = document.createElement('div');
            sRow.className = 'sub-row';
            sRow.appendChild(createCtrl(s, cfg.coresSubcategoria[s], 'coresSubcategoria', 'Subcategoria'));
            sList.appendChild(sRow);
          });
          div.appendChild(sList);
        }
        area.appendChild(div);
      });
    }
    
    function createCtrl(lbl, c, type, role) {
      const el = document.createElement('div');
      el.className = 'editor-item';
      el.dataset.keyRaw = lbl;
      el.dataset.keyNorm = normalizeKey(lbl);
      el.dataset.type = type;
      
      const bg = (c && c.fundo) ? c.fundo.toLowerCase() : '#ffffff';
      const txt = (c && c.texto) ? c.texto.toLowerCase() : '#000000';
      
      // MODIFICAÇÃO: Negrito é TRUE por padrão (se não estiver definido)
      const isBold = (c && typeof c.negrito !== 'undefined') ? c.negrito : true;
      const bld = isBold ? 'active' : '';
      const st = 'background:' + bg + ';color:' + txt + ';font-weight:' + (isBold ? 'bold' : 'normal');
      
      el.innerHTML = '<div class="item-header">' +
        '<div class="item-title">' + 
        (role === 'Subcategoria' ? '<span class="material-icons" style="font-size:14px;color:#aaa;margin-right:4px;flex-shrink:0;">subdirectory_arrow_right</span>' : '') +
        '<span class="item-label">' + lbl + '</span>' +
        '</div>' +
        '<div class="preview-box" style="' + st + '">ABC</div>' +
        '</div>' +
        '<div class="controls">' +
        '<div class="color-input-group">' +
        '<span class="color-label">Fundo</span>' +
        '<input type="color" class="inp-bg" value="' + bg + '">' +
        '</div>' +
        '<div class="color-input-group">' +
        '<span class="color-label">Texto</span>' +
        '<input type="color" class="inp-txt" value="' + txt + '">' +
        '</div>' +
        '<div class="btn-bold ' + bld + '">B</div>' +
        '<button class="btn-copy" title="Copiar formatação"><span class="material-icons" style="font-size:14px;">content_copy</span></button>' +
        '<button class="btn-reset" title="Resetar este item (Volta ao padrão: Negrito)"><span class="material-icons" style="font-size:14px;">refresh</span></button>' +
        (role === 'Categoria' ? '<button class="btn-reset-subs" title="Resetar TODAS as Subcategorias"><span class="material-icons" style="font-size:14px;">layers_clear</span></button>' : '') +
        '</div>';
      
      const iBg = el.querySelector('.inp-bg');
      const iTxt = el.querySelector('.inp-txt');
      const btn = el.querySelector('.btn-bold');
      const btnCopy = el.querySelector('.btn-copy');
      const btnReset = el.querySelector('.btn-reset');
      const prev = el.querySelector('.preview-box');
      
      const upd = function() {
        prev.style.backgroundColor = iBg.value;
        prev.style.color = iTxt.value;
        prev.style.fontWeight = btn.classList.contains('active') ? 'bold' : 'normal';
      };

      // --- NOVA LÓGICA DE INTERAÇÃO (Item 2.2) ---
      // Monitora mudanças de cor. Se o usuário escolher uma cor diferente do "neutro"
      // (Branco para fundo, Preto para texto), ativamos o negrito automaticamente.
      const handleColorChange = function() {
        const currentBg = iBg.value.toLowerCase();
        const currentTxt = iTxt.value.toLowerCase();
        
        // Se NÃO for neutro...
        if (currentBg !== '#ffffff' || currentTxt !== '#000000') {
           // ...e o botão não estiver ativo, ativa-o.
           if (!btn.classList.contains('active')) {
              btn.classList.add('active');
           }
        }
        // Atualiza a pré-visualização
        upd();
      };
      
      iBg.oninput = handleColorChange;
      iTxt.oninput = handleColorChange;
      
      btn.onclick = function() { 
        btn.classList.toggle('active'); 
        upd(); 
      };
      
      btnCopy.onclick = function() {
        CLIPBOARD_FORMAT = {
          bg: iBg.value,
          txt: iTxt.value,
          bold: btn.classList.contains('active')
        };
        
        document.querySelectorAll('.btn-copy').forEach(function(b) {
          b.classList.remove('copied');
        });
        btnCopy.classList.add('copied');
        setStatus('✅ Formatação copiada!', 'green');
        
        document.querySelectorAll('.editor-item').forEach(function(item) {
          if (item !== el) {
            item.style.cursor = 'pointer';
            item.style.boxShadow = '0 0 0 2px #1a73e8';
            item.onclick = function() {
              pasteFormat(item);
            };
          }
        });
      };
      
      // MODIFICAÇÃO: Reset agora ATIVA o negrito (Padrão)
      btnReset.onclick = function() {
        iBg.value = '#ffffff';
        iTxt.value = '#000000';
        btn.classList.add('active'); // Liga negrito
        upd();
      };
      
      if (role === 'Categoria') {
        const btnSubs = el.querySelector('.btn-reset-subs');
        if (btnSubs) {
          btnSubs.onclick = function() {
            if (!confirm('Resetar formatação de todas as subcategorias para o padrão (Negrito)?')) return;
            
            const group = el.closest('.group-container');
            if (!group) return;
            
            const subs = group.querySelectorAll('.sub-list .editor-item');
            if (!subs || subs.length === 0) {
              setStatus('⚠️ Nenhuma subcategoria encontrada.', 'orange');
              return;
            }
            
            subs.forEach(function(sub) {
              const sBg = sub.querySelector('.inp-bg');
              const sTxt = sub.querySelector('.inp-txt');
              const sBtn = sub.querySelector('.btn-bold');
              const sPrev = sub.querySelector('.preview-box');
              
              // Reseta para padrão: Branco, Preto, NEGRITO
              sBg.value = '#ffffff';
              sTxt.value = '#000000';
              sBtn.classList.add('active'); // Liga negrito
              
              sPrev.style.backgroundColor = '#ffffff';
              sPrev.style.color = '#000000';
              sPrev.style.fontWeight = 'bold';
            });
            
            setStatus('✅ ' + subs.length + ' subcategorias resetadas.', 'green');
            setTimeout(function() { setStatus(''); }, 2000);
          };
        }
      }
      
      return el;
    }
    
    function pasteFormat(targetEl) {
      if (!CLIPBOARD_FORMAT) return;
      
      const iBg = targetEl.querySelector('.inp-bg');
      const iTxt = targetEl.querySelector('.inp-txt');
      const btn = targetEl.querySelector('.btn-bold');
      const prev = targetEl.querySelector('.preview-box');
      
      iBg.value = CLIPBOARD_FORMAT.bg;
      iTxt.value = CLIPBOARD_FORMAT.txt;
      if (CLIPBOARD_FORMAT.bold) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
      
      prev.style.backgroundColor = CLIPBOARD_FORMAT.bg;
      prev.style.color = CLIPBOARD_FORMAT.txt;
      prev.style.fontWeight = CLIPBOARD_FORMAT.bold ? 'bold' : 'normal';
      
      document.querySelectorAll('.editor-item').forEach(function(item) {
        item.style.cursor = '';
        item.style.boxShadow = '';
        item.onclick = null;
      });
      
      document.querySelectorAll('.btn-copy').forEach(function(b) {
        b.classList.remove('copied');
      });
      
      setStatus('✅ Formatação aplicada!', 'green');
      setTimeout(function() { setStatus(''); }, 1500);
    }
    
    function salvar() {
      if (!CURRENT_LIST_ID) return;
      if (FONTE_ATIVA === 'CONFIG') {
        setStatus('❌ Não é possível salvar no modo CONFIG', 'red');
        return;
      }
      
      const nova = { cores: {}, coresSubcategoria: {} };
      const els = document.querySelectorAll('.editor-item');
      
      els.forEach(function(el) {
        const keyRaw = el.dataset.keyRaw;
        const type = el.dataset.type;
        
        if (!type || (type !== 'cores' && type !== 'coresSubcategoria')) {
          console.warn('Tipo inválido para item:', keyRaw);
          return;
        }
        
        const bg = el.querySelector('.inp-bg').value.toLowerCase();
        const txt = el.querySelector('.inp-txt').value.toLowerCase();
        const bold = el.querySelector('.btn-bold').classList.contains('active');
        
        // MODIFICAÇÃO: Neutro (que remove do BD) só é verdade se TUDO for padrão.
        // Padrão = Branco + Preto + COM NEGRITO.
        // Se for Sem Negrito (bold=false), isNeutral é false, e a regra é salva.
        const isNeutral = (bg === '#ffffff' && txt === '#000000' && bold === true);
        
        if (!isNeutral) {
          if (!nova[type]) nova[type] = {};
          nova[type][keyRaw] = { fundo: bg, texto: txt, negrito: bold };
        }
      });
      
      const payload = {};
      payload[CURRENT_LIST_ID] = nova;
      setStatus('Salvando...', 'orange');
      document.getElementById('saveBtn').disabled = true;
      
      google.script.run
        .withSuccessHandler(function(res) {
           document.getElementById('saveBtn').disabled = false;
           if(res.sucesso) {
             setStatus('✅ Salvo com sucesso!', 'green');
             if(GLOBAL_DATA[CURRENT_LIST_ID]) {
                 GLOBAL_DATA[CURRENT_LIST_ID].configuracaoSalva = nova;
                 GLOBAL_DATA[CURRENT_LIST_ID].configuracaoAtual = nova; 
             }
             setTimeout(function() { setStatus('', ''); }, 1500);
           } else {
             setStatus('❌ Erro: ' + res.erro, 'red');
           }
        })
        .withFailureHandler(function(e) {
           document.getElementById('saveBtn').disabled = false;
           setStatus('❌ Falha: ' + e, 'red');
        })
        .salvarConfiguracaoCores(payload);
    }
    
    function exportarJson() {
      setStatus('⏳ Exportando JSON...');
      google.script.run
        .withSuccessHandler(function(res) {
          if (!res || !res.sucesso) {
            setStatus('❌ Falha ao exportar: ' + (res && res.erro ? res.erro : 'erro desconhecido'), 'red');
            return;
          }
          document.getElementById('bulkJson').value = res.json || '{}';
          setStatus('✅ JSON exportado.');
        })
        .withFailureHandler(function(e) {
          setStatus('❌ Falha ao exportar: ' + (e && e.message ? e.message : e), 'red');
        })
        .exportarConfiguracaoCores();
    }

    function importarJson() {
      const txt = document.getElementById('bulkJson').value || '';
      if (!txt.trim()) {
        setStatus('⚠️ Cole um JSON antes de importar.', 'orange');
        return;
      }

      setStatus('⏳ Importando JSON...');
      google.script.run
        .withSuccessHandler(function(res) {
          if (!res || !res.sucesso) {
            setStatus('❌ Falha ao importar: ' + (res && res.erro ? res.erro : 'erro desconhecido'), 'red');
            return;
          }
          setStatus('✅ Importado. Listas: ' + (res.totalListas || 0));
          carregarDados();
        })
        .withFailureHandler(function(e) {
          setStatus('❌ Falha ao importar: ' + (e && e.message ? e.message : e), 'red');
        })
        .importarConfiguracaoCores(txt);
    }
    
    window.onload = function() {
      if (typeof google === 'undefined') { 
        showError("Ambiente desconhecido."); 
        return; 
      }
      carregarDados();

      document.getElementById('btnExportJson').addEventListener('click', exportarJson);
      document.getElementById('btnImportJson').addEventListener('click', importarJson);
      
      document.getElementById('toggleFonte').addEventListener('change', function(e) {
        FONTE_ATIVA = e.target.checked ? 'SIDEBAR' : 'CONFIG';
        const label = document.getElementById('labelFonte');
        const area = document.getElementById('dynamicContentArea');
        
        if (FONTE_ATIVA === 'CONFIG') {
          label.textContent = 'CONFIG (Padrão)';
          label.style.color = '#5f6368';
          area.style.opacity = '0.5';
          area.style.pointerEvents = 'none';
          setStatus('⚠️ Modo CONFIG: Editores desabilitados', 'orange');
        } else {
          label.textContent = 'Sidebar (Personalizado)';
          label.style.color = '#1a73e8';
          area.style.opacity = '1';
          area.style.pointerEvents = 'auto';
          setStatus('');
        }
        if (CURRENT_LIST_ID) render(CURRENT_LIST_ID);
      });
    };
  </script>
</body>
</html>